<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developers Dashboard</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="page">
    <header class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="nav-logo">
          <img src="https://via.placeholder.com/32" alt="Logo" id="siteLogo" />
          <span id="siteName">Science & Tech Club</span>
        </a>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <button class="btn" onclick="logout()">Logout</button>
        </nav>
      </div>
    </header>

    <main class="main">
      <section class="section">
        <h1 class="title">Developers Dashboard</h1>
        <p class="subtitle">Welcome, <span id="devName">Developer</span></p>
      </section>

      <section class="section grid grid-2">
        <div class="card">
          <h2>Site Configuration</h2>
          <form id="configForm">
            <div class="form-group">
              <label class="form-label">Logo URL</label>
              <input type="url" name="logoUrl" id="logoUrl" class="form-input" placeholder="https://..." />
            </div>
            <div class="form-group">
              <label class="form-label">Site Name</label>
              <input type="text" name="siteName" id="siteNameInput" class="form-input" placeholder="Science & Tech Club" />
            </div>
            <div class="form-group">
              <label class="form-label">Git Repository URL</label>
              <input type="url" name="gitRepo" id="gitRepo" class="form-input" placeholder="https://github.com/..." />
            </div>
            <button type="submit" class="btn">Save Configuration</button>
          </form>
        </div>

        <div class="card">
          <h2>Faculty Roles</h2>
          <form id="facultyRolesForm">
            <div class="form-group">
              <label class="form-label">Faculty Coordinator</label>
              <select name="coordinator" class="form-select" id="coordinatorSelect">
                <option value="">Select Faculty</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Faculty Manager</label>
              <select name="manager" class="form-select" id="managerSelect">
                <option value="">Select Faculty</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Faculty Advisor</label>
              <select name="advisor" class="form-select" id="advisorSelect">
                <option value="">Select Faculty</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Incharge (Principal)</label>
              <select name="incharge" class="form-select" id="inchargeSelect">
                <option value="">Select Faculty</option>
              </select>
            </div>
            <button type="submit" class="btn">Save Roles</button>
          </form>
        </div>
      </section>

      <section class="section">
        <div class="card">
          <h2>System Information</h2>
          <table class="table">
            <tr>
              <td>Backend API</td>
              <td id="backendUrl">-</td>
            </tr>
            <tr>
              <td>Database</td>
              <td>Supabase PostgreSQL</td>
            </tr>
            <tr>
              <td>Frontend</td>
              <td>Netlify Static</td>
            </tr>
            <tr>
              <td>Version</td>
              <td>1.0.0</td>
            </tr>
          </table>
        </div>
      </section>

      <section class="section">
        <div class="card">
          <h2>Quick Actions</h2>
          <div style="display:flex; gap:1rem; margin-top:1rem; flex-wrap:wrap;">
            <a href="#" id="gitRepoLink" class="btn" target="_blank">Open Git Repo</a>
            <button class="btn" onclick="viewLogs()">View Logs</button>
            <button class="btn" onclick="clearCache()">Clear Cache</button>
            <button class="btn" onclick="exportData()">Export Data</button>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      Science & Tech Club • Built by Developers team
    </footer>

    <div class="chatbot">
      <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
          <span class="chatbot-title">Club Guide</span>
          <button class="chatbot-close" id="chatbotClose">×</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
          <div class="chatbot-msg">
            <strong>Guide:</strong> Configure site settings and manage faculty roles.
          </div>
        </div>
        <form class="chatbot-input-wrap" id="chatbotForm">
          <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask..." />
          <button type="submit" class="chatbot-send">Send</button>
        </form>
      </div>
      <button class="btn" id="chatbotToggle">Help</button>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/chatbot.js"></script>
  <script>
    const user = checkAuth();
    document.getElementById("devName").textContent = user.username;
    document.getElementById("backendUrl").textContent = window.API_BASE;

    // Load config
    async function loadConfig() {
      try {
        const res = await fetch(window.API_BASE + "/config", {
          headers: getAuthHeaders()
        });
        const config = await res.json();
        
        if (config.logoUrl) {
          document.getElementById("logoUrl").value = config.logoUrl;
          document.getElementById("siteLogo").src = config.logoUrl;
        }
        if (config.siteName) {
          document.getElementById("siteNameInput").value = config.siteName;
          document.getElementById("siteName").textContent = config.siteName;
        }
        if (config.gitRepo) {
          document.getElementById("gitRepo").value = config.gitRepo;
          document.getElementById("gitRepoLink").href = config.gitRepo;
        }
      } catch (err) {
        console.error(err);
      }
    }

    // Save config
    document.getElementById("configForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {
        logoUrl: fd.get("logoUrl"),
        siteName: fd.get("siteName"),
        gitRepo: fd.get("gitRepo")
      };

      try {
        await fetch(window.API_BASE + "/config", {
          method: "PUT",
          headers: getAuthHeaders(),
          body: JSON.stringify(body)
        });
        alert("Configuration saved!");
        loadConfig();
      } catch (err) {
        alert("Error saving configuration");
      }
    });

    // Load faculty
    async function loadFaculty() {
      try {
        const res = await fetch(window.API_BASE + "/users?role=faculty", {
          headers: getAuthHeaders()
        });
        const faculty = await res.json();
        
        const selects = ["coordinatorSelect", "managerSelect", "advisorSelect", "inchargeSelect"];
        selects.forEach(id => {
          const select = document.getElementById(id);
          faculty.forEach(f => {
            const option = document.createElement("option");
            option.value = f.id;
            option.textContent = f.username;
            select.appendChild(option);
          });
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Save faculty roles
    document.getElementById("facultyRolesForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {
        coordinator: fd.get("coordinator"),
        manager: fd.get("manager"),
        advisor: fd.get("advisor"),
        incharge: fd.get("incharge")
      };

      try {
        await fetch(window.API_BASE + "/config/faculty-roles", {
          method: "PUT",
          headers: getAuthHeaders(),
          body: JSON.stringify(body)
        });
        alert("Faculty roles saved!");
      } catch (err) {
        alert("Error saving faculty roles");
      }
    });

    function viewLogs() {
      alert("Logs feature coming soon!");
    }

    function clearCache() {
      if (confirm("Clear browser cache?")) {
        localStorage.clear();
        alert("Cache cleared!");
      }
    }

    function exportData() {
      alert("Data export feature coming soon!");
    }

    loadConfig();
    loadFaculty();
  </script>
</body>
</html>
