<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard ‚Ä¢ Science & Tech Club</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .admin-topbar { display: flex; gap: 1rem; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
    .pill { border: 1px solid var(--border); padding: 0.35rem 0.7rem; font-size: 0.75rem; color: var(--muted); background: var(--bg-alt); }
    .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .tab { border: 1px solid var(--border); background: transparent; color: var(--fg); padding: 0.45rem 0.9rem; font-size: 0.75rem; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
    .tab.active { background: var(--accent); color: #000; }
    .panel { display: none; }
    .panel.active { display: block; }
    .two-col { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .two-col { grid-template-columns: 1fr 1fr; } }
    .hint { font-size: 0.75rem; color: var(--muted); margin-top: 0.6rem; }
    .row { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
    @media (min-width: 768px) { .row-2 { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>
  <div class="page">
    <header class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="nav-logo">
          <img id="siteLogo" src="https://via.placeholder.com/32" alt="Logo">
          <span id="siteName">Science & Tech Club</span>
        </a>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <button class="btn" onclick="logout()">Logout</button>
        </nav>
      </div>
    </header>

    <main class="main">
      <div class="admin-topbar">
        <div>
          <h1 class="title" style="margin-bottom:0.25rem;">Admin Dashboard</h1>
          <div class="subtitle">Manage users, roles, passwords, uploads, config</div>
        </div>
        <div class="pill">Admin: <span id="adminName">admin</span></div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="uploads">Uploads</button>
        <button class="tab" data-tab="roles">Roles</button>
        <button class="tab" data-tab="passwords">Passwords</button>
        <button class="tab" data-tab="config">Config</button>
      </div>

      <!-- UPLOADS -->
      <section class="panel active" id="panel-uploads">
        <div class="two-col">
          <div class="card">
            <h2>Upload Students CSV</h2>
            <input type="file" accept=".csv" id="studentsFile" style="margin:1rem 0;">
            <button class="btn" onclick="uploadStudents()">Upload Students</button>
            <div class="hint">Headers: username,email,department,year,password,interests</div>
          </div>

          <div class="card">
            <h2>Upload Faculty CSV</h2>
            <input type="file" accept=".csv" id="facultyFile" style="margin:1rem 0;">
            <button class="btn" onclick="uploadFaculty()">Upload Faculty</button>
            <div class="hint">Headers: username,email,department,password</div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <h2>Promote Students</h2>
          <p>Moves all students to next year (1‚Üí2, 2‚Üí3, 3‚Üí4, 4‚Üígraduated).</p>
          <button class="btn" onclick="promoteAll()">Promote All</button>
        </div>
      </section>

      <!-- ROLES -->
      <section class="panel" id="panel-roles">
        <div class="card">
          <h2>Set User Role</h2>
          <form id="roleForm" class="row row-2" style="margin-top:1rem;">
            <div class="form-group">
              <label class="form-label">Username</label>
              <input class="form-input" id="roleUsername" placeholder="student1" required>
            </div>

            <div class="form-group">
              <label class="form-label">Role</label>
              <select class="form-select" id="roleValue" required>
                <option value="student">Student</option>
                <option value="faculty">Faculty</option>
                <option value="admin">Admin</option>
                <option value="committee_chair">Committee Chair</option>
                <option value="committee_vice_chair">Committee Vice Chair</option>
                <option value="secretary">Secretary</option>
                <option value="vice_secretary">Vice Secretary</option>
                <option value="executive_head">Executive Head</option>
                <option value="executive_vice_head">Executive Vice Head</option>
                <option value="representative_head">Representative Head</option>
                <option value="representative_vice_head">Representative Vice Head</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Department (for heads)</label>
              <select class="form-select" id="roleDepartment">
                <option value="">None</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Electrical">Electrical</option>
                <option value="Mechanical">Mechanical</option>
                <option value="Civil">Civil</option>
                <option value="ECE">Electronics & Communication</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Additional Flags</label>
              <select class="form-select" id="roleFlags">
                <option value="">None</option>
                <option value="isCommittee">Committee Member</option>
                <option value="isExecutive">Executive</option>
                <option value="isRepresentative">Representative</option>
                <option value="isDeveloper">Developer</option>
              </select>
            </div>

            <div class="form-group" style="grid-column:1/-1;">
              <button class="btn" type="submit">Save Role</button>
              <span id="roleMsg" class="hint" style="margin-left:0.75rem;"></span>
            </div>
          </form>
        </div>
      </section>

      <!-- PASSWORDS -->
      <section class="panel" id="panel-passwords">
        <div class="two-col">
          <div class="card">
            <h2>Reset Single Password</h2>
            <form id="passwordForm" style="margin-top:1rem;">
              <div class="form-group">
                <label class="form-label">Username</label>
                <input class="form-input" id="pwdUsername" placeholder="student1" required>
              </div>

              <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-input" id="pwdPassword" placeholder="Min 6 characters" required>
              </div>

              <button class="btn" type="submit">Reset Password</button>
              <span id="pwdMsg" class="hint" style="margin-left:0.75rem;"></span>
            </form>
          </div>

          <div class="card">
            <h2>Bulk Password Reset (CSV)</h2>
            <p>Upload CSV with username,password columns.</p>
            <input type="file" accept=".csv" id="bulkPasswordFile" style="margin:1rem 0;">
            <button class="btn" onclick="bulkPasswords()">Upload & Reset</button>
            <div class="hint">Headers: username,password (min 6 chars each)</div>
          </div>
        </div>
      </section>

      <!-- CONFIG -->
      <section class="panel" id="panel-config">
        <div class="card">
          <h2>Site Configuration</h2>
          <form id="siteConfigForm" style="margin-top:1rem;">
            <div class="form-group">
              <label class="form-label">Site Name</label>
              <input id="cfgSiteName" class="form-input" placeholder="Science & Tech Club">
            </div>

            <div class="form-group">
              <label class="form-label">Logo URL</label>
              <input id="cfgLogoUrl" class="form-input" placeholder="https://...">
            </div>

            <div class="form-group">
              <label class="form-label">Git Repo URL</label>
              <input id="cfgGitRepoUrl" class="form-input" placeholder="https://github.com/...">
            </div>

            <button class="btn" type="submit">Save Configuration</button>
            <span id="cfgMsg" class="hint" style="margin-left:0.75rem;"></span>
          </form>
        </div>
      </section>
    </main>

    <footer class="footer">
      Science & Tech Club ‚Ä¢ Built by Developers team
    </footer>

    <div class="chatbot">
      <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
          <span class="chatbot-title">ü§ñ Club Chatbot</span>
          <button class="chatbot-close" id="chatbotClose">√ó</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages"></div>
        <form class="chatbot-input-wrap" id="chatbotForm">
          <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask me anything...">
          <button type="submit" class="chatbot-send">Send</button>
        </form>
      </div>
      <button class="btn" id="chatbotToggle">üí¨ Chat</button>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/chatbot.js"></script>
  <script src="js/site.js"></script>

  <script>
  // Tab switching
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("panel-" + btn.dataset.tab).classList.add("active");
    });
  });

  // Auth guard
  const user = checkAuth();
  document.getElementById("adminName").textContent = user.username || "admin";
  if (user.role !== "admin") location.href = "login.html";

  // Upload Students
  async function uploadStudents() {
    const file = document.getElementById("studentsFile").files[0];
    if (!file) return alert("Select CSV file");
    
    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(window.API_BASE + "/admin/upload-students", {
      method: "POST",
      headers: { Authorization: `Bearer ${localStorage.getItem("club_token")}` },
      body: fd
    });

    const data = await res.json().catch(() => ({}));
    alert(data.message || (res.ok ? "Uploaded!" : "Upload failed"));
  }

  // Upload Faculty
  async function uploadFaculty() {
    const file = document.getElementById("facultyFile").files[0];
    if (!file) return alert("Select CSV file");
    
    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(window.API_BASE + "/admin/upload-faculty", {
      method: "POST",
      headers: { Authorization: `Bearer ${localStorage.getItem("club_token")}` },
      body: fd
    });

    const data = await res.json().catch(() => ({}));
    alert(data.message || (res.ok ? "Uploaded!" : "Upload failed"));
  }

  // Promote Students
  async function promoteAll() {
    if (!confirm("Promote all students to next year?")) return;
    
    const res = await fetch(window.API_BASE + "/users/promote", {
      method: "POST",
      headers: getAuthHeaders()
    });
    
    const data = await res.json().catch(() => ({}));
    alert(data.message || (res.ok ? "Promoted!" : "Failed"));
  }

  // Set Role
  document.getElementById("roleForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("roleMsg");
    msg.textContent = "Saving...";

    const body = {
      username: document.getElementById("roleUsername").value.trim(),
      role: document.getElementById("roleValue").value,
      department: document.getElementById("roleDepartment").value,
      flag: document.getElementById("roleFlags").value
    };

    const res = await fetch(window.API_BASE + "/admin/set-role", {
      method: "PUT",
      headers: getAuthHeaders(),
      body: JSON.stringify(body)
    });

    msg.textContent = res.ok ? "‚úÖ Role updated" : "‚ùå Failed";
    if (res.ok) document.getElementById("roleForm").reset();
  });

  // Reset Password (FIXED - added closing parenthesis)
  document.getElementById("passwordForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("pwdMsg");
    msg.textContent = "Resetting...";

    const body = {
      username: document.getElementById("pwdUsername").value.trim(),
      password: document.getElementById("pwdPassword").value
    };

    const res = await fetch(window.API_BASE + "/admin/reset-password", {
      method: "PUT",
      headers: getAuthHeaders(),
      body: JSON.stringify(body)
    });  // ‚Üê FIXED: Added closing parenthesis

    const data = await res.json().catch(() => ({}));
    msg.textContent = res.ok ? "‚úÖ " + data.message : "‚ùå " + (data.message || "Failed");
    
    if (res.ok) document.getElementById("passwordForm").reset();
  });

  // Bulk Passwords
  async function bulkPasswords() {
    const file = document.getElementById("bulkPasswordFile").files[0];
    if (!file) return alert("Select CSV file");
    
    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch(window.API_BASE + "/admin/bulk-passwords", {
      method: "POST",
      headers: { Authorization: `Bearer ${localStorage.getItem("club_token")}` },
      body: fd
    });

    const data = await res.json().catch(() => ({}));
    let msg = data.message || (res.ok ? "Updated!" : "Failed");
    if (data.errors) msg += "\nErrors: " + data.errors.join(", ");
    alert(msg);
  }

  // Load Config
  async function loadConfigIntoForm() {
    const res = await fetch(window.API_BASE + "/config");
    const cfg = await res.json().catch(() => ({}));
    document.getElementById("cfgSiteName").value = cfg?.site_name || "";
    document.getElementById("cfgLogoUrl").value = cfg?.logo_url || "";
    document.getElementById("cfgGitRepoUrl").value = cfg?.git_repo_url || "";
  }

  // Save Config
  document.getElementById("siteConfigForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("cfgMsg");
    msg.textContent = "Saving...";

    const body = {
      siteName: document.getElementById("cfgSiteName").value.trim(),
      logoUrl: document.getElementById("cfgLogoUrl").value.trim(),
      gitRepoUrl: document.getElementById("cfgGitRepoUrl").value.trim()
    };

    const res = await fetch(window.API_BASE + "/config", {
      method: "PUT",
      headers: getAuthHeaders(),
      body: JSON.stringify(body)
    });

    msg.textContent = res.ok ? "‚úÖ Saved. Refresh to see logo." : "‚ùå Failed";
    if (res.ok) await loadConfigIntoForm();
  });

  loadConfigIntoForm();
</script>

</body>
</html>
